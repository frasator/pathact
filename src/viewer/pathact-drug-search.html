<dom-module id="pathact-drug-search">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
        }

        #search {
            width: 100%;
        }

        .list {
            position: relative;
            box-sizing: border-box;
            overflow-y: auto;
            border: 1px solid var(--divider-color);
            background-color: var(--light-primary-color);
        }
    </style>
    <template>
        <jso-search id="search" placeholder="Drug search..." display-key="n" min-query-length="3" on-item-select="handleSearchSelect"></jso-search>
        <label class="jso" style="margin-top:10px;"><i class="fa fa-flask"></i>Drug list:</label>
        <div id="relatedGeneList" class="list flex">
            <template is="dom-repeat" items="{{selectedDrugList}}">
                <pathact-drug-item drug="{{item}}" on-remove-drug-item="handleRemoveDrug"></pathact-drug-item>
            </template>
        </div>
        <label class="jso" style="margin-top:10px;"><i class="fa fa-flask" style="color:#68ad17"></i>Genes affected by drug list:</label>
        <div id="relatedGeneList" class="list flex">
            <template is="dom-repeat" items="{{relatedGeneList}}">
                <pathact-gene-option name="{{item.name}}" drugactions="{{item.drugactions}}"></pathact-gene-option>
            </template>
        </div>
    </template>
    <script>
        Polymer({
            is: 'pathact-drug-search',
            properties: {
                drugList: {
                    type: Array,
                    value: function() {
                        return []
                    }
                },
                drugActionMap: {
                    type: Object
                },
                selectedDrugList: {
                    type: Array,
                    value: function() {
                        return []
                    }
                },
                selectedDrugMap: {
                    type: Object,
                    value: function() {
                        return {}
                    }
                },
                relatedGeneList: {
                    type: Array,
                    value: function() {
                        return []
                    }
                }
            },
            observers: [
                'selectedDrugListChanged(selectedDrugList.splices)'
            ],
            ready: function() {
                this._initSearch();
            },
            clean: function() {
                this.set('selectedDrugList', []);
                this.set('relatedGeneList', []);
                this.$.search.clean();
            },
            selectedDrugListChanged: function() {
                this._rebuildMap();
                this._updateRelatedGenes();
            },
            handleSearchSelect: function(e) {
                var drug = e.detail
                if (this.selectedDrugMap[drug.i] == null) {
                    var insertPosition = this.push('selectedDrugList', drug) - 1;
                    this.selectedDrugMap[drug.i] = insertPosition;
                }
                this.$.search.clean();
                this.$.search.hideList();
            },
            handleRemoveDrug: function(e) {
                var drug = e.detail;
                this.splice('selectedDrugList', this.selectedDrugMap[drug.i], 1);
            },
            _updateRelatedGenes: function(drugs) {
                var drugs = this.selectedDrugList;
                // this._saveAttributesToFile();
                var relatedGeneList = [];
                var auxGeneMap = {};

                for (var i = 0; i < drugs.length; i++) {
                    var drug = drugs[i];
                    var targets = drug.t;
                    for (var j = 0; j < targets.length; j++) {
                        var target = targets[j];
                        if (target.g != "") {
                            var drugvalue;
                            if (target.a != "") {
                                // check action field contains more than one action names separated by comma.
                                var actionSplit = target.a.split(',');
                                drugvalue = parseFloat(this.drugActionMap[actionSplit[0].trim().toLowerCase()].value);
                            } else {
                                drugvalue = parseFloat(this.drugActionMap['unknown'].value);
                            }
                            var drugaction = {
                                drug: drug.n,
                                drugid: drug.i,
                                action: target.a,
                                drugvalue: drugvalue
                            };
                            var relatedGene;
                            if (auxGeneMap[target.g] == null) {
                                relatedGene = {
                                    name: target.g,
                                    manual: false,
                                    drugactions: []
                                };
                                relatedGeneList.push(relatedGene);
                                auxGeneMap[target.g] = relatedGene;
                            } else {
                                relatedGene = auxGeneMap[target.g];
                            }
                            relatedGene.drugactions.push(drugaction);
                        }
                    }
                }
                this.set('relatedGeneList', relatedGeneList);
            },
            _rebuildMap: function() {
                var map = {};
                for (var i = 0; i < this.selectedDrugList.length; i++) {
                    var item = this.selectedDrugList[i];
                    map[item.i] = i;
                }
                this.set('selectedDrugMap', map);
            },
            _initSearch: function() {
                var me = this;
                var search = function(query, cb) {
                    var results = [];
                    for (var i = 0; i < me.drugList.length; i++) {
                        var drug = me.drugList[i];
                        if (drug.n.toUpperCase().indexOf(query.toUpperCase()) >= 0) {
                            results.push(drug);
                        }
                    }
                    cb(results);
                };
                this.$.search.setSearchFunction(search);
            }
        });
    </script>
</dom-module>

<dom-module id="pathact-drug-item">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            word-break: break-all;
            padding: 1px 7px;
        }

        .name {
            margin-right: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .close {
            cursor: pointer;
        }
    </style>
    <template>
        <div class="horizontal layout">
            <div class="name flex">{{drug.n}}</div>
            <div class="close" on-click="handleRemove"><i class="fa fa-times"></i></div>
        </div>
    </template>
    <script>
        Polymer({
            is: 'pathact-drug-item',
            properties: {
                drug: {
                    type: Object
                }
            },
            handleRemove: function(e) {
                this.fire('remove-drug-item', this.drug);
            },
        });
    </script>
</dom-module>
