<script src="../bower_components/file-saver.js/FileSaver.js"></script>

<link rel="import" href="../bower_components/polymer/polymer.html">
<link rel="import" href="../bower_components/iron-flex-layout/classes/iron-flex-layout.html">
<link rel="import" href="../bower_components/iron-list/iron-list.html">

<link rel="import" href="../lib/jsorolla/src/lib/components/jso-application-behavior.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-opencga-manager-behavior.html">
<link rel="import" href="../lib/jsorolla/src/network-viewer/jso-network-viewer.html">

<link rel="import" href="../lib/jsorolla/src/lib/components/jso-help-menu.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/jso-opencga-input-text.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-opencga-footer.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/jso-opencga-header.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/jso-search.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/jso-tooltip.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/files/jso-opencga-browser.html">
<link rel="import" href="../lib/jsorolla/src/lib/components/opencga/files/jso-opencga-job-browser.html">

<script src="expression-validator.js"></script>
<link rel="import" href="viewer/pathact-viewer.html">
<link rel="import" href="pathact-form.html">
<link rel="import" href="jso-pathways-result.html">

<link rel="import" href="pathact-home.html">

<dom-module id="pathact-element">
    <style>
        :host {
            display: block;
            position: relative;
            cursor: default;
            font-size: 13px;
            background-color: var(--default-primary-color);
            height: 100%;
            width: 100%;
        }

        jso-opencga-header {
            position: absolute;
            top: 0;
        }

        jso-opencga-footer {
            position: absolute;
            bottom: 0;
        }

        .content {
            position: absolute;
            width: 100%;
            top: 60px;
            /*height: calc(100vh - 60px);*/
            /*background-color: transparent;*/
        }

        jso-job-result {
            min-height: 100%;
        }

        #browserPanel {
            position: absolute;
            top: 0px;
            left: 0;
            width: 600px;
        }

        #jobsPanel {
            position: absolute;
            top: 0px;
            right: 0;
            width: 600px;
        }

        #browser {
            /*width: 600px;*/
            height: 400px;
        }

        @media (max-width: 1100px) {
            .option-text {
                display: none;
            }
        }

        .userid {
            color: var(--accent-color);
            font-size: 16px;
        }

        #description {
            color: var(--accent-color);
            font-weight: normal;
        }

        pathact-home {
            height: calc(100vh - 160px);
            overflow-y: auto;
        }

        pathact-viewer {
            height: calc(100vh - 60px);
            overflow-y: auto;
        }

        pathact-form {
            height: calc(100vh - 60px);
            overflow-y: auto;
        }
    </style>
    <template>
        <div class="content" menu-option="home,start,pathact">
            <jso-panel hidden fixed modal closable id="configureDrugActionsPanel" on-hidden="handlePanelHidden">
                <div class="header">
                    <i class="fa fa-sliders"></i> Settings
                </div>
                <div id="drugActionList" class="container flex" style="width:650px; padding:7px;">
                    <label class="jso">Configure fold change:</label>
                    <br>
                    <div style="width:200px">
                        <input id="foldChangeInput" class="jso" type="number" step="0.1" min="0" value="{{foldChange::input}}" on-change="handleFoldChange">
                    </div>
                    <br>
                    <label class="jso">Configure drug action weight:</label>
                    <br>
                    <div class="list horizontal layout wrap">
                        <template is="dom-repeat" items="{{drugActionList}}">
                            <pathact-action-option style="width:315px" name="{{item.name}}" value="{{item.value}}" on-change="handleActionWeightChange"></pathact-action-option>
                        </template>
                    </div>
                </div>
            </jso-panel>
        </div>

        <div class="content" menu-option="pathact">
            <pathact-viewer id="pathactViewer" drug-action-list="{{drugActionList}}" drug-action-map="{{drugActionMap}}" fold-change="{{foldChange}}" on-goback="handleViewerGoBack"></pathact-viewer>
        </div>
        <div class="content" menu-option="start">
            <pathact-form id="pathactForm" selectedOption="{{selectedOption}}" bioformats="{{bioformats}}" projects="{{projects}}" allowed-tools="{{allowedTools}}" on-jobselect="handleJobSelect"></pathact-form>
        </div>

        <div class="content" menu-option="home">
            <pathact-home id="home" on-start="handleHomeStart" isLogged="{{isLogged}}"></pathact-home>
        </div>

        <jso-opencga-header id="jsoHeader" hide-jobs hide-browse selected-option="{{selectedOption}}" user-data="{{userData}}" on-login="handleLogin" on-logout="handleLogout">
            <!--<div hidden class="icon">-->
            <!--<img src="" style="height: 0px;margin: 5px 0px 0 0;">-->
            <!--</div>-->
            <!-- <div class="icon">
                <img src="./images/pathiways-logo.svg" style="height: 54px;margin: 3px 5px 0 0;">
            </div> -->
            <div class="title horizontal layout center" style="margin-left:15px;">
                Path
                <span style="font-weight:normal;">Act</span>
            </div>
            <span id="description" class="description">
                Actionable pathway workshop
            </span>

            <div id="menu" class="menu horizontal layout flex">
                <div class="flex"></div>
                <div show-on-login title="Settings" class="option" on-click="handleLoggedOnlyMenuPanel" data-panel="configureDrugActionsPanel">
                    <i class="fa fa-sliders"></i>
                    <span class="option-text">Settings</span>
                </div>
                <!-- <div style="margin-left:4vw;"></div>
                <div title="Open Pathiways form" class="option" on-click="handleMenuOption" data-option="home">
                    <i class="fa fa-magic"></i>
                    <span class="option-text">Home</span>
                </div>
                <div title="Open Pathiways form" class="option" on-click="handleLoggedOnlyMenuOption" data-option="pathact">
                    <i class="fa fa-magic"></i>
                    <span class="option-text">Gene action</span>
                </div>
                <div class="flex" style="margin-left:2vw;"></div>
                <div title="Browse my data" class="option" on-click="handleLoggedOnlyMenuPanel" data-panel="browserPanel">
                    <i class="fa fa-cloud"></i>
                    <span class="option-text">My data</span>
                </div>
                <div title="Browse my jobs" class="option" on-click="handleLoggedOnlyMenuPanel" data-panel="jobsPanel">
                    <i class="fa fa-rocket"></i>
                    <span class="option-text">My jobs</span>
                </div>
                <div style="margin-left:2vw;"></div> -->
            </div>

            <jso-help-menu class="helpmenu" selectedOption="{{selectedOption}}">
                <a href="http://pathact.babelomics.org/doc" target="_blank">
                    <i class="fa fa-book"></i> &nbsp; Documentation
                </a>
                <div on-mousedown="handleExample">
                    <i class="fa fa-lightbulb-o"></i> &nbsp; Run example
                </div>
            </jso-help-menu>
        </jso-opencga-header>

        <jso-opencga-footer menu-option="home,login,signup,profile,remember">
            PathAct
            <br> Created by
            <span style="font-weight:bold;">Computational Genomics Department</span>
            <br> Principe Felipe Research Center, Valencia, Spain
            <br> 2015
        </jso-opencga-footer>
    </template>

    <script>
        Polymer({
            is: "pathact-element",
            behaviors: [JsoApplicationBehavior],
            properties: {
                bioformats: {
                    type: Array,
                    value: [{
                        value: 'DATAMATRIX_EXPRESSION',
                        text: 'Data matrix expression',
                        validator: ExpressionValidator,
                        hint: 'Data matrix expression matrix is a Tab-separated values file. The columns correspond to samples of the experiment and rows correspond to gene/probe/protein names.'
                    }]
                },
                allowedTools: {
                    type: Array,
                    value: ['pathways.pathact-init']
                },
                cellBaseHost: {
                    type: String,
                    value: CellBaseManager.host
                },
                opencgaHost: {
                    type: String,
                    value: OpencgaManager.host
                },
                networkViewer: {
                    type: Object
                },
                projects: {
                    type: Array,
                    notify: true,
                    observer: 'projectsChanged'
                },
                drugActionList: {
                    type: Array,
                    notify: true
                },
                drugActionMap: {
                    type: Object,
                    notify: true
                },
                foldChange: {
                    type: Number
                }
            },
            ready: function() {
                var me = this;
                this.checkShowMenuOnLogin();

                var fc = localStorage.getItem("pathact_foldchange");
                if (fc == null) {
                    this.set('foldChange', 2);
                    localStorage.setItem("pathact_foldchange", this.foldChange);
                } else {
                    this.set('foldChange', parseFloat(fc));
                }

                var localActions = localStorage.getItem("pathact_actions");
                if (localActions == null) {
                    this._openRemoteFile('./drug-actions.json', function(content) {
                        var allActions = JSON.parse(content);
                        var nameMap = {};
                        var actions = [];
                        var actionsMap = {};
                        for (var i = 0; i < allActions.length; i++) {
                            var a = allActions[i];
                            var n = a.name.toLowerCase();
                            if (nameMap[n] !== true) {
                                nameMap[n] = true;
                                var obj = {
                                    name: a.name,
                                    value: a.value
                                };
                                actions.push(obj);
                                actionsMap[n] = obj;
                            }
                        }
                        me.set('drugActionList', actions);
                        me.set('drugActionMap', actionsMap);
                        localStorage.setItem("pathact_actions", JSON.stringify(actions));
                        localStorage.setItem("pathact_actionsmap", JSON.stringify(actionsMap));
                    });
                } else {
                    var actions = JSON.parse(localActions);
                    var actionsMap = JSON.parse(localStorage.getItem("pathact_actionsmap"));
                    this.set('drugActionList', actions);
                    this.set('drugActionMap', actionsMap);
                }
            },
            handleActionWeightChange: function() {
                localStorage.setItem("pathact_actions", JSON.stringify(this.drugActionList));
                var actionsMap = {};
                for (var i = 0; i < this.drugActionList.length; i++) {
                    var a = this.drugActionList[i];
                    actionsMap[a.name] = a;
                }
                localStorage.setItem("pathact_actionsmap", JSON.stringify(actionsMap));
                this.set('drugActionMap', actionsMap);
                this.$.pathactViewer._processDrugRelatedGenes();
            },
            handleFoldChange: function() {
                var fc = localStorage.setItem("pathact_foldchange", this.$.foldChangeInput.value);
                this.set('foldChange', this.$.foldChangeInput.value);
            },
            handleFileSelect: function(e) {
                console.log("file");
                console.log(e.detail);
                var file = e.detail;
                if (file.index && file.index.status == 'READY') {}
            },
            handleJobSelect: function(e) {
                var job = e.detail;
                if (job && job.status === 'READY') {
                    if (this.$.pathactViewer.jobItem != null) {
                        if (this.$.pathactViewer.jobItem.id !== job.id) {
                            this.$.pathactViewer.set('jobItem', job);
                        }
                        this.set('selectedOption', 'pathact');
                    } else {
                        this.$.pathactViewer.set('jobItem', job);
                        this.set('selectedOption', 'pathact');
                    }
                }
            },
            handleCloseJobResult: function(e) {
                this.set('selectedOption', 'home');
            },
            handleLogin: function() {
                this.selectedOption = "home";
                if (this._lastLogedRequest) {
                    this._lastLogedRequest.hidden = false;
                    this._lastLogedRequest = null;
                }

                this.$.home.isLogged = true;
                this.setMenu('start');
                this.checkShowMenuOnLogin();
            },
            handleLogout: function() {
                // this.$.pathactViewer.clean();
                this.$.home.isLogged = false;
                this.setMenu('home');
                this.checkShowMenuOnLogin();
            },
            handleUserNeedRefresh: function() {
                this.$.jsoHeader.getUserInfo(true);
            },
            handleHomeStart: function() {
                if (this.$.jsoHeader.isLogged == true) {
                    this.setMenu('start');
                } else {
                    this.$.jsoHeader.anonymousSign();
                }
            },
            handleViewerGoBack: function() {
                this.handleHomeStart();
            },

            /**/
            handleExample: function(e) {
                if (this.$.jsoHeader.isLogged != true) {
                    this._lastExampleRequest = true;
                    this.$.jsoHeader.anonymousSign();
                } else {
                    this.runExample();
                }
            },
            runExample: function() {
                this.async(function() {
                    this.$.pathactForm.handleLoadExample();
                }, 100);
            },
            projectsChanged: function(neo, old) {
                if (this.$.jsoHeader.isLogged == true) {
                    if (neo.length > 0) {
                        if (this._lastExampleRequest != null) {
                            this.runExample();
                            this._lastExampleRequest = null;
                        }
                    }
                }
            },
            _openRemoteFile: function(filepath, cb) {
                var me = this;
                var request = new XMLHttpRequest();
                request.onload = function() {
                    cb(this.responseText);
                };
                request.onerror = function() {
                    console.log('Error loading remote file');
                };
                request.open("GET", filepath);
                request.send();
            },

        });
    </script>
</dom-module>
