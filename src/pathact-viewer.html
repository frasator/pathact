<dom-module id="pathact-viewer">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            height: 100%;
            background-color: var(--light-secondary-color);
            @apply(--layout-horizontal);
        }

        #form {
            position: absolute;
            height: 100%;
            width: 100%;
            box-sizing: border-box;
            padding: 8px 10px 10px 10px;
            /*margin: 0px auto 0px auto;*/
            /*max-width: 1000px;*/
            /*border: 1px solid #c6d0da;*/
            /*box-shadow: 2px 6px 15px 8px rgba(0, 0, 0, 0.30);*/
        }

        #right {
            position: relative;
            width: 280px;
            box-sizing: border-box;
            height: 100%;
            padding-top: 4px;
        }

        #left {
            position: relative;
            width: 280px;
            box-sizing: border-box;
            height: 100%;
            padding-top: 4px;
        }

        #left > .jso-btn {
            margin: 4px 0;
        }

        #center {
            box-sizing: border-box;
            height: 100%;
            margin: 0 10px;
        }

        jso-network-viewer {
            border: 1px solid var(--divider-color);
        }

        #koControl {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100px;
            box-shadow: 4px 4px 4px rgba(0, 0, 0, 0.2);
            background-color: var(--light-primary-color);
            border: 1px solid var(--divider-color);
            padding: 5px 10px 10px 10px;
        }

        .list,
        .plist,
        #inputGeneList {
            position: relative;
            box-sizing: border-box;
            overflow-y: auto;
            border: 1px solid var(--divider-color);
            background-color: var(--light-primary-color);
        }

        #inputGeneList > div {
            padding: 1px 4px;
        }

        .plist > div {
            cursor: pointer;
            padding: 1px 4px;
            border: 1px solid transparent;
            color: #555;
        }

        .plist > div:hover {
            background-color: var(--hover-color);
            border-color: var(--accent-color);
        }

        .plist > div[data-checked] {
            background-color: var(--accent-color);
        }

        .plist > div > span[data-haschanged] {
            font-family: FontAwesome;
            margin-right: 3px;
            color: #000;
            font-weight: bold;
        }

        .plist > div > span[data-down][data-haschanged]:before,
        .plist > div > span[data-up][data-haschanged]:before {
            font-family: FontAwesome;
            margin-right: 3px;
            color: #aaa;
        }

        .plist > div > span[data-up][data-haschanged]:before {
            content: '\f176';
        }

        .plist > div > span[data-down][data-haschanged]:before {
            content: '\f175';
        }

        .plist > div > span[data-upsig][data-haschanged]:before {
            color: #cc0000;
        }

        .plist > div > span[data-downsig][data-haschanged]:before {
            color: #005aa3;
        }

        #fileList {
            padding: 4px;
        }

        #updateGenesButton.button {
            background-color: var(--dark-button-color) !important;
            color: var(--text-primary-color) !important;
        }

        #updateGenesButton.button:hover {
            background-color: var(--light-button-color) !important;
        }

        #backButton {
            width: 100px;
        }

        .button[report-disabled] {
            color: var(--secondary-text-color) !important;
            background-color: var(--light-primary-color) !important;
        }

        .button[report-disabled]:hover {
            color: var(--secondary-text-color) !important;
            background-color: var(--light-primary-color) !important;
        }

        #geneSearch {
            width: 100%;
            margin-bottom: 3px;
        }

        #loading {
            z-index: 100000;
            position: fixed;
            top: 0;
            bottom: 0;
            left: 0;
            right: 0;
            /*width: 100%;*/
            /*height: 100%;*/
            background-color: rgba(0, 0, 0, 0.60);
            font-size: 18px;
        }

        #loading > div {
            box-shadow: 2px 2px 3px 0px rgba(0, 0, 0, 0.3);
            border: 1px solid rgba(0, 0, 0, 0.2);
            background-color: #d75a00;
            /*background-color: var(--accent-color);*/
            color: #fff;
            padding: 10px 40px;
        }

        #reportPanel {
            position: fixed;
            height: 100%;
            width: 100%;
            top: 60px;
            left: 0;
        }

        #reportPanelContainer {
            box-sizing: border-box;
            width: 100%;
            height: calc(100% - 60px);
            background-color: #fff !important;
            overflow-y: scroll;
            overflow-x: none;
        }
    </style>
    <template>
        <form id="form" class="horizontal layout">
            <div id="left" class="vertical layout">
                <label class="jso" style="margin-top:0px;"><i class="fa fa-gavel"></i> Gene list:</label>
                <div id="updateGenesButton" class="jso-btn jso-btn-shdw button" on-click="handleUpdateButton"> <i class="fa fa-refresh"></i>&nbsp; Update </div>
                <!-- <div id="cleanGenesButton" class="jso-btn jso-btn-shdw button" on-click="handleCleanButton"> <i class="fa fa-refresh"></i>&nbsp; Clean </div> -->
                <jso-search id="geneSearch" placeholder="Search genes..." on-item-select="handleGeneSearch"></jso-search>
                <div id="geneList" class="list flex">
                    <template is="dom-repeat" items="{{geneList}}">
                        <pathact-gene-option name="{{item.name}}" value="{{item.value}}" manual="{{item.manual}}" drugactions="{{item.drugactions}}" on-remove="handleRemoveGene" on-change="handleChangeGene"></pathact-gene-option>
                    </template>
                </div>
                <label class="jso"><i class="fa fa-flask"></i> Additional drug targets:</label>
                <div id="relatedGeneList" class="list flex">
                    <template is="dom-repeat" items="{{relatedGeneList}}">
                        <pathact-gene-option name="{{item.name}}" manual="{{item.manual}}" drugactions="{{item.drugactions}}"></pathact-gene-option>
                    </template>
                </div>

                <label class="jso" style="margin-top:10px;"><i class="fa fa-flask"></i> Related drug list:</label>
                <div id="relatedDrugList" class="list flex">
                    <template is="dom-repeat" items="{{relatedDrugList}}">
                        <pathact-drug-option drug="{{item}}" on-selected-change="handleDrugSelectedChange"></pathact-drug-option>
                    </template>
                </div>
            </div>
            <div id="center" class="flex">
                <div class="horizontal layout center">
                    <div id="backButton" class="jso-btn jso-btn-shdw button" on-click="handleBackButton"> <i class="fa fa-arrow-left"></i>&nbsp; Back </div>
                    <div style="margin-left:30px;">
                        <label class="jso">Job:
                        </label>{{jobItem.name}} - {{computeInputFileName(jobItem.params.exp_file)}}</div>
                    <div class="flex"></div>
                    <div id="reportButton" on-click="handleReportButton" class="jso-btn jso-btn-shdw button" style="margin:0 2px 2px 0;"><i class="fa fa-file-text-o"></i> &nbsp; Show last update report</div>
                </div>
                <jso-network-viewer id="networkViewer" style="height:calc(100% - 27px);" hide-node-render hide-edge-render hide-bar hide-tool-bar hide-edition-bar hide-status-bar disable-context-menu on-leftclickvertex="handleNetworkViewerVertexClick"></jso-network-viewer>
            </div>
            <div id="right">
                <label class="jso">Pathway list:</label>
                <div id="pathwayList" class="plist" style="height:calc(40% - 23px);">
                    <template is="dom-repeat" items="{{pathwayList}}">
                        <div on-click="handlePathwayClick" data-checked$="{{isPathwaySelected(item, selectedPathway)}}">
                            <span data-up$="{{item.up}}" data-upsig$="{{item.upsig}}" data-haschanged$="{{item.haschanged}}"></span>
                            <span data-down$="{{item.down}}" data-downsig$="{{item.downsig}}" data-haschanged$="{{item.haschanged}}"></span>
                            <span data-haschanged$="{{item.haschanged}}">{{item.name}}</span>
                        </div>
                    </template>
                </div>
                <label class="jso" style="margin-top:5px;">Circuit list:</label>
                <div id="pathList" class="plist" style="height:calc(40% - 23px);">
                    <template is="dom-repeat" items="{{pathList}}">
                        <div on-click="handlePathClick" data-checked$="{{isPathSelected(item, selectedPath)}}">
                            <span data-up$="{{item.up}}" data-upsig$="{{item.upsig}}" data-haschanged$="{{item.haschanged}}"></span>
                            <span data-down$="{{item.down}}" data-downsig$="{{item.downsig}}" data-haschanged$="{{item.haschanged}}"></span>
                            <span data-haschanged$="{{item.haschanged}}">{{item.shortname}}</span>
                        </div>
                    </template>
                </div>
                <!-- <div hidden> -->
                <label class="jso" style="margin-top:5px;">Last update gene list:</label>
                <div id="inputGeneList" style="height:calc(20% - 27px);">
                    <template is="dom-repeat" items="{{_inputGeneList}}">
                        <div>
                            <span>{{item.gene}}</span> -
                            <span>{{item.value}}</span>
                        </div>
                    </template>
                </div>
                <!-- </div> -->
            </div>

            <div id="koControl">
                <label class="jso">Activity value:</label>
                <input class="jso" type="number" min="0" max="1" step="0.05" on-change="handlekoControlChange" value="{{koInputValue::input}}" />
            </div>

        </form>
        <div id="loading" hidden$="{{!loading}}" class="horizontal layout center-justified jso-unselectable">
            <div class="self-center">
                <i class="fa fa-circle-o-notch fa-spin"></i> Loading...
            </div>
        </div>
        <jso-panel hidden closable id="reportPanel">
            <div class="header">
                Report
            </div>
            <div id="reportPanelContainer" class="container">
            </div>
        </jso-panel>
    </template>

    <script>
        Polymer({
            is: 'pathact-viewer',
            behaviors: [JsoOpencgaManagerBehavior],
            properties: {
                jobItem: {
                    type: Object,
                    observer: 'jobItemChanged'
                },
                jobFolder: {
                    type: Object
                },
                reportFile: {
                    type: Object,
                    value: null
                },
                pathwayList: {
                    type: Array
                },
                selectedPathway: {
                    type: Object
                },
                pathList: {
                    type: Array
                },
                selectedPath: {
                    type: Object
                },
                drugActionList: {
                    type: Array
                },
                drugActionMap: {
                    type: Object
                },
                foldChange: {
                    type: Number
                },
                relatedDrugList: {
                    type: Array,
                    value: function() {
                        return []
                    },
                },
                relatedGeneList: {
                    type: Array
                },
                _drugToGeneMap: {
                    type: Object
                },
                _geneToDrugMap: {
                    type: Object
                },
                loading: {
                    type: Boolean,
                    value: false
                },
                _resultFileNameMap: {
                    type: Object
                },
                _resultFileInitNameMap: {
                    type: Object
                },

                geneList: {
                    type: Array,
                    value: function() {
                        return []
                    },
                },
                geneMap: {
                    type: Object,
                    value: function() {
                        return {}
                    }
                },
                koInputValue: {
                    type: Number,
                    value: 0.1
                },
                defaultKoValue: {
                    type: Number,
                    value: 0.1
                },
                lastSelectedNode: {
                    type: Object,
                },
                _inputGeneList: {
                    type: Array,
                    value: function() {
                        return []
                    }
                },
                _pathwayInitExpression: {
                    type: Object,
                }
            },
            observers: [
                'geneListchanged(geneList.splices)'
            ],
            handleBackButton: function() {
                this.fire('goback');
            },
            computeInputFileName: function(name) {
                return name.split('/').pop();
            },
            jobItemChanged: function(neo, old) {
                if (neo) {
                    var me = this;
                    var job = neo;
                    var fileIds = job.input.concat(job.output);
                    this.loading = true;
                    me._getFileBean(job.outDirId, function(jobOutDir) {
                        me.set('jobFolder', jobOutDir);

                        me._getFilesBeans(fileIds, function(files) {
                            me._resultFileNameMap = {};
                            me._resultFileInitNameMap = {};
                            for (var i = 0; i < files.length; i++) {
                                var f = files[i];
                                /*Nya careful!!!*/
                                if (f.path.indexOf('sifs4CellMaps_init') == -1) {
                                    me._resultFileNameMap[f.name] = f;
                                }
                                if (f.path.indexOf('sifs4CellMaps_init') != -1) {
                                    me._resultFileInitNameMap[f.name] = f;
                                }
                            }
                            me._getFileContent(me._resultFileNameMap['path_info.json'].id, function(content) {
                                me._loadPathwayList(JSON.parse(content));
                                me.loading = false;
                            });
                            me._getFileContent(me._resultFileNameMap['report.xml'].id, function(content) {
                                console.log(content);
                                if (content.indexOf('ko_update') != -1) {
                                    var result = document.createElement('jso-' + 'pathways' + '-result');
                                    var el = me.$.reportPanelContainer.querySelector('jso-pathways-result');
                                    if (el != null) {
                                        Polymer.dom(me.$.reportPanelContainer).removeChild(el);
                                    }
                                    result.set('job', job);
                                    Polymer.dom(me.$.reportPanelContainer).appendChild(result);
                                    me._loadInputGenes();
                                }
                            });
                            me.clean();
                            me.set('reportFile', me._resultFileNameMap['report.xml']);
                            if (me.reportFile.attributes.pathact != null && me.reportFile.attributes.pathact.geneList != null) {
                                var restoreRelatedDrugList = me.reportFile.attributes.pathact.relatedDrugList;
                                me._loadGeneList(me.reportFile.attributes.pathact.geneList);
                                me._loadRelatedDrugList(restoreRelatedDrugList);
                            }
                        });

                    });

                }
            },
            _pwSortFn: function(a, b) {
                if (a.haschanged && !b.haschanged) {
                    return -1;
                }
                if (b.haschanged && !a.haschanged) {
                    return 1;
                }
                return a.name.localeCompare(b.name)
            },
            _init: function() {
                var me = this;
                // this._openRemoteFile('./pathway_list.json', function(content) {
                //     var pathwayList = [];
                //     var pwMap = JSON.parse(content);
                //     for (key in pwMap) {
                //         pathwayList.push({
                //             title: pwMap[key],
                //             name: key
                //         });
                //     }
                //     me.set('pathwayList', pathwayList);
                // });

                this._openRemoteFileArrayBuffer('./drugmap.json.gz', function(content) {
                    var map = JSON.parse(pako.ungzip(content, {
                        to: 'string'
                    }));
                    me.set('_drugToGeneMap', map);
                });
                this._openRemoteFileArrayBuffer('./genemap.json.gz', function(content) {
                    var map = JSON.parse(pako.ungzip(content, {
                        to: 'string'
                    }));
                    me.set('_geneToDrugMap', map);
                });

                // localStorage.removeItem("pathact_actions");
            },
            ready: function() {
                var me = this;
                this._init();
                this._initGeneSearch();

                // this.$.networkViewer.addEventListener('hoververtex', function(e) {
                // var x = e.detail.e.clientX;
                // var y = e.detail.e.clientY;
                // console.log(x + '-' + y);
                // });
                // this.$.networkViewer.addEventListener('hoverleave', function(e) {
                //     console.log(e)
                // });
                // this.$.networkViewer.addEventListener('leftclickvertex', function(e) {
                //     console.log(e);
                // });
                this.$.networkViewer.addEventListener('selectback', function(e) {
                    me._hideKoControl();
                });
            },
            clean: function() {
                this.set('pathList', null);
                this.set('pathwayList', null);
                this.set('geneList', []);
                this.set('geneMap', {});
                this.set('relatedDrugList', []);
                this.set('_inputGeneList', []);
                this.set('selectedPathway', null);
                this.set('selectedPath', null);
                this.set('reportFile', null);
                this.$.networkViewer.startOver();
                this.loading = false;
                for (var key in this._drugToGeneMap) {
                    this._drugToGeneMap[key].s = null;
                }
            },
            handleReportButton: function(e) {
                if (this.reportFile != null) {
                    this.$.reportPanel.show();
                } else {
                    this.$.reportPanel.hide();
                }
            },
            isPathwaySelected: function(pw, selectedPathway) {
                return selectedPathway != null && pw.id === selectedPathway.id;
            },
            isPathSelected: function(p, selectedPath) {
                return selectedPath != null && p.id === selectedPath.id;
            },
            _loadPathwayList: function(o) {
                console.log(o);
                var pathwayList = [];
                for (var i = 0; i < o.length; i++) {
                    var pw = o[i];
                    pathwayList.push(pw);
                }
                o.sort(this._pwSortFn);
                this.set('pathwayList', o);
                if (this.selectedPathway != null) {
                    this._selectPathway(this.selectedPathway);
                } else {
                    this._selectPathway(o[0]);
                }
            },
            handlePathwayClick: function(e) {
                console.log(e.model.item);
                this._selectPathway(e.model.item);
                this.set('pathList', e.model.item.paths);
            },
            handlePathClick: function(e) {
                var path = e.model.item;
                console.log(path);
                if (this.selectedPath != null && path.id === this.selectedPath.id) {
                    this.set('selectedPath', null);
                    this.$.networkViewer.$.nodeRender.removeVisualSet('opacity');
                    this.$.networkViewer.$.edgeRender.removeVisualSet('opacity');
                } else {
                    this.set('selectedPath', path);
                    var attrId = e.model.item.id.split('__').pop();
                    this.$.networkViewer.$.nodeRender.applyVisualSet({
                        attribute: attrId,
                        displayProperty: 'opacity',
                        type: "discrete",
                        matches: {
                            "1": "1",
                            "0": "0.1"
                        },
                        points: [],
                        parse: "string",
                        enabled: true
                    });
                    this.$.networkViewer.$.edgeRender.applyVisualSet({
                        attribute: attrId,
                        displayProperty: 'opacity',
                        type: "discrete",
                        matches: {
                            "1": "1",
                            "0": "0.1"
                        },
                        points: [],
                        parse: "string",
                        enabled: true
                    });
                }

            },
            _selectPathway: function(pw) {
                var me = this;
                var pwid = pw.id;
                this.set('selectedPathway', pw);
                pw.paths.sort(this._pwSortFn);
                this.set('pathList', pw.paths);

                console.log(pwid);
                this.loading = true;
                this._getFileContent(this._resultFileNameMap[pwid + '.sif'].id, function(sifContent) {
                    me._getFileContent(me._resultFileNameMap[pwid + '.natt'].id, function(nattContent) {
                        me._getFileContent(me._resultFileInitNameMap[pwid + '.natt'].id, function(nattInitContent) {
                            me._getFileContent(me._resultFileNameMap[pwid + '.eatt'].id, function(eattContent) {

                                //init expression attributes
                                new AttributeNetworkDataAdapter({
                                    async: false,
                                    useFirstLineAsColumnNames: true,
                                    dataSource: new StringDataSource(nattInitContent),
                                    handlers: {
                                        'data:load': function(e) {
                                            me._pathwayInitExpression = {};
                                            for (var i = 0; i < e.attributes.length; i++) {
                                                var att = e.attributes[i];
                                                me._pathwayInitExpression[att.id] = att.exp;
                                            }
                                        }
                                    }
                                });

                                me.$.networkViewer.loadSif(sifContent);
                                me.$.networkViewer.loadNodeAttributes(nattContent, true);
                                me.$.networkViewer.loadEdgeAttributes(eattContent, true);

                                // me.$.networkViewer.$.nodeRender.applyDirect('color', 'strokeColor');
                                me.$.networkViewer.$.nodeRender.applyDirect('exp_col', 'color');
                                me.$.networkViewer.$.nodeRender.applyDirect('shape', 'shape');
                                me.$.networkViewer.$.nodeRender.applyDirect('width', 'size');
                                me.$.networkViewer.$.nodeRender.applyDirect('labelSize', 'labelSize');

                                me.$.networkViewer.$.edgeRender.applyDirect('color', 'color');
                                me.$.networkViewer.$.edgeRender.applyDirect('head', 'shape');
                                /*EXAMPLE*/
                                // nodeRender.applyVisualSet({
                                //     attribute: "drugs",
                                //     displayProperty: "color",
                                //     enabled: true,
                                //     matches: matches,
                                //     parse: "string",
                                //     type: "categorical"
                                // });

                                me.$.networkViewer.setVertexDefaultPositionX('X', true, false);
                                me.$.networkViewer.setVertexDefaultPositionY('Y', true, true);
                                // me.$.networkViewer.setVertexDefaultLabelAttribute('genesList');
                                me.$.networkViewer.setVertexDefaultLabelAttribute('label');

                                me._updateGeneListVerticesStroke();

                                me.loading = false;
                            });
                        });
                    });
                });
            },
            _updateGeneListVerticesStroke: function() {
                var v, name;
                for (var i = 0; i < this.$.networkViewer.vertices.length; i++) {
                    v = this.$.networkViewer.vertices[i];
                    v.renderer.set('strokeSize', 2);
                    v.renderer.set('strokeColor', '#888888');

                    if (Array.isArray(this.relatedGeneList)) {
                        for (var j = 0; j < this.relatedGeneList.length; j++) {
                            name = this.relatedGeneList[j].name;
                            if (v.attributes['label'].indexOf(name) != -1) {
                                v.renderer.set('strokeSize', 6);
                                v.renderer.set('strokeColor', '#59ee08');
                            }
                        }
                    }

                    for (var j = 0; j < this.geneList.length; j++) {
                        name = this.geneList[j].name;
                        if (v.attributes['label'].indexOf(name) != -1) {
                            v.renderer.set('strokeSize', 6);
                            v.renderer.set('strokeColor', '#ee6908');
                        }
                    }
                }
            },
            geneListchanged: function() {
                this._rebuildGeneMap();
                this._updateDrugList();
            },
            _updateDrugList: function() {
                if (this.geneList.length > 0) {
                    var newDrugList = [];
                    var newDrugMap = {};
                    for (var i = 0; i < this.geneList.length; i++) {
                        var g = this.geneList[i];
                        var drugIds = this._geneToDrugMap[g.name];
                        if (Array.isArray(drugIds)) {
                            for (var j = 0; j < drugIds.length; j++) {
                                var drugId = drugIds[j];
                                var d = this._drugToGeneMap[drugId];
                                if (newDrugMap[d.i] == null) {
                                    // d.s = false;
                                    newDrugMap[d.i] = d;
                                    newDrugList.push(d);
                                }
                            }
                        }
                    }

                    for (var i = 0; i < this.geneList.length; i++) {
                        var gene = this.geneList[i];
                        var newGeneDrugActions = [];
                        if (Array.isArray(gene.drugactions)) {
                            for (var k = 0; k < gene.drugactions.length; k++) {
                                var gda = gene.drugactions[k];
                                if (newDrugMap[gda.drugid] != null && newDrugMap[gda.drugid].s === true) {
                                    newGeneDrugActions.push(gda);
                                }
                            }
                            var pos = this.geneMap[gene.name];
                            this.set('geneList.' + pos + '.drugactions', newGeneDrugActions);
                        }
                    }

                    this.set('relatedDrugList', newDrugList);
                    this._processDrugRelatedGenes();
                } else {
                    this.set('relatedDrugList', []);
                    this.set('relatedGeneList', []);
                }
                this._updateGeneListVerticesStroke();
            },
            handleDrugSelectedChange: function(e) {
                this._drugToGeneMap[e.model.item.i] = e.model.item;
                this._updateDrugList();
            },
            _processDrugRelatedGenes: function() {
                this._saveAttributesToFile();
                var relatedGeneList = [];
                var auxGeneMap = {};

                var selectedDrugs = [];
                var selectedDrugsMap = {};
                for (var i = 0; i < this.relatedDrugList.length; i++) {
                    var drug = this.relatedDrugList[i];
                    if (drug.s === true) {
                        selectedDrugs.push(drug);
                        selectedDrugsMap[drug.i] = drug;
                    }
                }

                for (var i = 0; i < selectedDrugs.length; i++) {
                    var drug = selectedDrugs[i];
                    var targets = drug.t;
                    for (var j = 0; j < targets.length; j++) {
                        var target = targets[j];
                        if (target.g != "") {
                            var drugvalue;
                            if (target.a != "") {
                                // check action field contains more than one action names separated by comma.
                                var actionSplit = target.a.split(',');
                                drugvalue = parseFloat(this.drugActionMap[actionSplit[0].trim().toLowerCase()].value);
                            } else {
                                drugvalue = parseFloat(this.drugActionMap['unknown'].value);
                            }
                            var drugaction = {
                                drug: drug.n,
                                drugid: drug.i,
                                action: target.a,
                                drugvalue: drugvalue
                            };
                            if (this.geneMap[target.g] == null) {
                                var relatedGene;
                                if (auxGeneMap[target.g] == null) {
                                    relatedGene = {
                                        name: target.g,
                                        manual: false,
                                        drugactions: []
                                    };
                                    relatedGeneList.push(relatedGene);
                                    auxGeneMap[target.g] = relatedGene;
                                } else {
                                    relatedGene = auxGeneMap[target.g];
                                }
                                relatedGene.drugactions.push(drugaction);
                            } else {
                                var pos = this.geneMap[target.g];
                                var gene = this.geneList[pos];
                                if (gene.drugactions == null) {
                                    gene.drugactions = [];
                                }
                                var found = false;
                                var updated_drugactions = [];
                                for (var k = 0; k < gene.drugactions.length; k++) {
                                    var gda = gene.drugactions[k];
                                    for (var l = 0; l < selectedDrugs.length; l++) {
                                        var sd = selectedDrugs[l];
                                        if (sd.n == gda.drug) {
                                            updated_drugactions.push(gda)
                                        }
                                    }
                                    if (gda.drug == drugaction.drug) {
                                        found = true;
                                    }
                                }
                                if (found === false) {
                                    updated_drugactions.push(drugaction);
                                }
                                this.set('geneList.' + pos + '.drugactions', updated_drugactions);
                            }
                        }
                    }
                }
                this.set('relatedGeneList', relatedGeneList);
            },
            handleCleanButton: function(e) {
                // this._updateGenes('SOS1\t0.69');
            },
            handleUpdateButton: function(e) {
                if (this.loading == false) {
                    var me = this;
                    var ko_file_lines = [];
                    for (var i = 0; i < this.geneList.length; i++) {
                        var gene = this.geneList[i];
                        var names = gene.name.split(' ');
                        var value;
                        if (Array.isArray(gene.drugactions) && gene.drugactions.length > 0) {
                            var dv = 1;
                            for (var j = 0; j < gene.drugactions.length; j++) {
                                var da = gene.drugactions[j];
                                dv *= da.drugvalue;
                            }
                            value = dv;
                        } else {
                            var value = gene.value;
                        }
                        for (var j = 0; j < names.length; j++) {
                            var name = names[j];
                            ko_file_lines.push(name + "\t" + value);
                        }
                    }
                    for (var i = 0; i < this.relatedGeneList.length; i++) {
                        var gene = this.relatedGeneList[i];
                        var value;
                        if (Array.isArray(gene.drugactions) && gene.drugactions.length > 0) {
                            var dv = 1;
                            for (var j = 0; j < gene.drugactions.length; j++) {
                                var da = gene.drugactions[j];
                                dv *= da.drugvalue;
                            }
                            value = dv;
                        } else {
                            var value = gene.value;
                        }
                        ko_file_lines.push(gene.name + "\t" + value);
                    }
                    var ko_file_content = ko_file_lines.join('\n') + '\n';
                    if (ko_file_content.trim() != "") {
                        this._updateGenes(ko_file_content);
                    }
                }
            },
            _updateGenes: function(ko_file_content) {
                var me = this;
                if (this.loading == false) {
                    this._saveAttributesToFile();
                    console.log(ko_file_content);
                    var ko_file = new Blob([ko_file_content], {
                        type: 'text/plain'
                    });

                    var formData = new FormData();

                    var split2 = this.jobItem.params.exp_file.split('/');
                    split2.pop();
                    var workingFolderPath = split2.join('/') + '/' + this.jobFolder.path;
                    console.log(workingFolderPath);

                    // formData.append('working_folder', this.reportFile.attributes.pathact.workingFolderPath);
                    formData.append('working_folder', workingFolderPath);
                    formData.append('fold_change', this.foldChange);
                    formData.append('ko_file', ko_file, 'ko_file.txt');

                    var xhr = new XMLHttpRequest();
                    xhr.open('POST', PATHACT_HOST + '/update', true);
                    xhr.onload = function(e) {
                        var response = JSON.parse(this.responseText);
                        me.loading = false;
                        me._getFileContent(me._resultFileNameMap['path_info.json'].id, function(content) {
                            me._loadPathwayList(JSON.parse(content));
                            me.loading = false;

                            me._getFileContent(me._resultFileNameMap['report.xml'].id, function(content) {
                                console.log(content);
                                if (content.indexOf('ko_update') != -1) {
                                    var result = document.createElement('jso-' + 'pathways' + '-result');
                                    var el = me.$.reportPanelContainer.querySelector('jso-pathways-result');
                                    if (el != null) {
                                        Polymer.dom(me.$.reportPanelContainer).removeChild(el);
                                    }
                                    result.set('job', me.jobItem);
                                    Polymer.dom(me.$.reportPanelContainer).appendChild(result);
                                    me._loadInputGenes();
                                }
                            });
                        });
                    };
                    this.loading = true;
                    xhr.send(formData);
                }
            },

            handlekoControlChange: function(e) {
                if (this.lastSelectedNode != null) {
                    this._addGene(this.lastSelectedNode, parseFloat(e.currentTarget.value), true);
                }
            },
            _addGene: function(name, value, manual) {
                if (this.geneMap[name] == null) {
                    var insertPosition = this.push('geneList', {
                        name: name,
                        value: value,
                        manual: manual
                    }) - 1;
                    this.geneMap[name] = insertPosition;
                } else {
                    var position = this.geneMap[name];
                    var key = 'geneList.' + position + '.value';
                    this.set(key, value);
                    var el = this.$.geneList.querySelector('pathact-gene-option[name="' + name + '"]');
                    el.set('value', value);
                    // el.$.input.value = value;
                }
                this._saveAttributesToFile();
            },
            handleRemoveGene: function(e) {
                var name = e.detail;
                this.splice('geneList', this.geneMap[name], 1);
                var key = 'geneMap.' + name;
                this.set(key, null);
                this._rebuildGeneMap();
                this._saveAttributesToFile();
            },
            handleChangeGene: function() {
                this._saveAttributesToFile();
            },
            _rebuildGeneMap: function() {
                for (var i = 0; i < this.geneList.length; i++) {
                    var item = this.geneList[i];
                    this.geneMap[item.name] = i;
                }
            },
            _saveAttributesToFile: function() {
                var me = this;
                if (this.reportFile != null) {
                    var attr = this.reportFile.attributes.pathact;
                    if (attr == null) {
                        attr = {};
                    }
                    attr.geneList = this.geneList;
                    if (this.geneList.length === 0) {
                        this.set('relatedDrugList', []);
                    }
                    var relatedDrugListToSave = [];
                    for (var i = 0; i < this.relatedDrugList.length; i++) {
                        var rd = this.relatedDrugList[i];
                        relatedDrugListToSave.push({
                            i: rd.i,
                            s: rd.s
                        });
                    }
                    attr.relatedDrugList = relatedDrugListToSave;
                    this._updateFileAttributes(this.reportFile.id, {
                        pathact: attr
                    }, function() {});
                }
            },
            _loadGeneList: function(list) {
                this.set('geneList', list);
            },
            _loadRelatedDrugList: function(list) {
                if (list != null) {
                    var relatedDrugList = [];
                    for (var i = 0; i < list.length; i++) {
                        var rd = list[i];
                        var relatedDrug = this._drugToGeneMap[rd.i];
                        relatedDrug.s = rd.s;
                        relatedDrugList.push(relatedDrug);
                    }

                    this.set('relatedDrugList', relatedDrugList);
                    this._processDrugRelatedGenes();
                }
            },
            handleNetworkViewerVertexClick: function(e) {
                var v = this.$.networkViewer.graph.getVertexById(e.detail.vertexId);
                this.lastSelectedNode = v.attributes.label;

                if (v.id.indexOf("_func") == -1) {
                    if (this.geneList[this.geneMap[this.lastSelectedNode]] != null) {
                        this.koInputValue = this.geneList[this.geneMap[this.lastSelectedNode]].value;
                    } else {
                        this.koInputValue = parseFloat(this._pathwayInitExpression[v.id]).toFixed(2);
                    }

                    var nvbcr = this.$.networkViewer.getBoundingClientRect();
                    this._showKoControl(e.detail.x + nvbcr.left + 15, e.detail.y + nvbcr.top + 15);
                } else {
                    this._hideKoControl();
                }
            },
            _showKoControl: function(x, y) {
                this.$.koControl.style.display = "block";
                this.$.koControl.style.top = y + 'px';
                this.$.koControl.style.left = x + 'px';
            },

            _hideKoControl: function() {
                this.$.koControl.style.display = "none";
            },
            _openRemoteFile: function(filepath, cb) {
                var me = this;
                var request = new XMLHttpRequest();
                request.onload = function() {
                    cb(this.responseText);
                };
                request.onerror = function() {
                    console.log('Error loading remote file');
                };
                request.open("GET", filepath);
                request.send();
            },
            _openRemoteFileArrayBuffer: function(filepath, cb) {
                var me = this;
                var request = new XMLHttpRequest();
                request.onload = function() {
                    cb(this.response);
                };
                request.onerror = function() {
                    console.log('Error loading remote file');
                };
                request.open("GET", filepath);
                request.responseType = 'arraybuffer';
                request.send();
            },

            handleGeneSearch: function(e) {
                var name = e.detail;
                if (this.geneMap[name] == null) {
                    this._addGene(name, this.defaultKoValue, true);
                }
            },
            _initGeneSearch: function() {
                var search = function(query, cb) {
                    CellBaseManager.get({
                        species: 'hsapiens',
                        category: 'feature',
                        subCategory: 'id',
                        query: query.toUpperCase(),
                        resource: 'starts_with',
                        params: {
                            limit: 10
                        },
                        async: true,
                        success: function(data, textStatus, jqXHR) {
                            if (data.response != null && data.response.length > 0 && data.response[0].result != null) {
                                cb(data.response[0].result);
                            } else {
                                cb([]);
                            }
                        },
                        error: function() {
                            cb([]);
                        }
                    });
                };
                var parse = function(results) {
                    var items = [];
                    for (var i = 0; i < results.length; i++) {
                        var r = results[i];
                        items.push(r.name);
                    }
                    return items;
                };
                this.$.geneSearch.setSearchFunction(search);
                this.$.geneSearch.setParseFunction(parse);
                // this.$.knockoutGenesSearch.setSearchFunction(search);
                // this.$.knockoutGenesSearch.setParseFunction(parse);
            },
            _loadInputGenes: function() {
                var me = this;
                this._getFileContent(this._resultFileNameMap['ko.txt'].id, function(content) {
                    var parsedContent = me._parseTabularFile(content);
                    me.set('_inputGeneList', parsedContent.data);
                });
            },
            _parseTabularFile: function(textContent) {
                var lines = textContent.split('\n');
                if (lines.length > 0) {
                    var line, fields, field, data = [],
                        columns = [],
                        obj;
                    var firstLine = lines[0].replace('#', '');
                    fields = firstLine.split('\t');
                    for (var i = 0; i < fields.length; i++) {
                        field = fields[i];
                        field = field.trim();
                        var name = field.replace(/ /gi, '_');
                        var width = 150;
                        if (i === 0) {
                            width = 400;
                        }
                        columns.push({
                            name: name,
                            title: name,
                            width: width
                        });
                    }

                    if (columns.length) {
                        for (var i = 1; i < lines.length; i++) {
                            line = lines[i];
                            if (line != '') {
                                fields = line.split('\t');
                                obj = {};
                                for (var j = 0; j < fields.length; j++) {
                                    field = fields[j].trim();
                                    column = columns[j];
                                    obj[column.name] = field;
                                }
                                data.push(obj);
                            }
                        }
                    }
                    return {
                        columns: columns,
                        data: data
                    };
                }
            }
        });
    </script>
</dom-module>

<dom-module id="pathact-action-option">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            word-break: break-all;
        }

        #main {
            margin-top: 3px;
            margin-left: 6px;
            margin-right: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .name {
            margin-right: 3px;
            text-transform: capitalize;
        }

        .value {
            width: 80px;
        }
    </style>
    <template>
        <div id="main" class="horizontal layout center">
            <div class="name flex">{{name}}:</div>
            <div class="value">
                <input class="jso" type="number" max="1" min="0" step="0.05" value="{{value::input}}" />
            </div>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'pathact-action-option',
        properties: {
            name: {
                type: String,
                reflectToAttribute: true,
                notify: true
            },
            value: {
                type: String,
                reflectToAttribute: true,
                notify: true,
                observer: 'valueChanged'
            },
        },
        valueChanged: function() {
            this.fire('changed', this.value);
        }
    });
</script>

<dom-module id="pathact-gene-option">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            word-break: break-all;
        }

        :host[manual] {
            color: var(--primary-text-color);
        }

        #main {
            margin-top: 3px;
            margin-left: 6px;
            margin-right: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }

        .name {
            margin-right: 3px;
        }

        .value {
            width: 80px;
        }

        .delete {
            margin-left: 3px;
            color: var(--secondary-text-color);
        }

        .delete:hover {
            color: #880000 !important;
        }

        .fa {
            text-align: center;
            width: 10px;
        }

        input[readonly] {
            color: #777 !important;
        }

        .drugaction {
            margin: 1px;
            padding: 1px 2px;
            background-color: #ddd;
        }

        .fa-flask {
            color: #40be20;
        }

        .fa-flash {
            color: #ff8a00;
        }
    </style>
    <template>
        <div id="main" class="horizontal layout center">
            <div class="name flex">{{name}}</div>
            <div class="value">
                <input id="input" class="jso" type="number" max="1" min="0" step="0.05" value="{{internalValue::input}}" readonly$="{{checkAtLeastOneDrugAction(drugactions)}}" />
            </div>
            <div hidden="{{!manual}}" class="delete jso-btn" on-click="handleRemove">
                <i class="fa fa-times"></i>
            </div>
        </div>
        <div class="horizontal layout wrap">
            <template is="dom-repeat" items="{{drugactions}}">
                <div class="drugaction" hidden$="{{!checkAtLeastOneDrugAction(drugactions)}}">
                    <i class="fa fa-flask"></i> {{item.drug}} <i hidden$="{{!existsAction(item.action)}}" class="fa fa-flash"></i> {{item.action}}
                </div>
            </template>
        </div>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'pathact-gene-option',
        properties: {
            name: {
                type: String,
                reflectToAttribute: true,
                notify: true
            },
            manual: {
                type: Boolean,
                reflectToAttribute: true,
                value: false,
                observer: 'manualChanged'
            },
            value: {
                type: Number,
                notify: true,
                value: -1,
                observer: 'valueChanged'
            },
            drugactions: {
                type: Array,
                value: function() {
                    return []
                },
                observer: 'drugactionsChanged'
            },
            internalValue: {
                type: Number,
                notify: true,
                observer: 'internalValueChanged',
                value: 0
            }
        },
        handleRemove: function() {
            this.fire('remove', this.name);
        },
        handleInput: function(e) {
            this.fire('changed', e.currentTarget.value);
        },
        internalValueChanged: function(neo, old) {
            if (this.drugactions == null || this.drugactions.length === 0) {
                this.value = this.internalValue;
            }
            this.fire('changed', this.internalValue);
        },
        existsAction: function(a) {
            return a != null && a !== '';
        },
        checkAtLeastOneDrugAction: function(drugactions) {
            return Array.isArray(drugactions) && drugactions.length > 0;
        },
        valueChanged: function(neo, old) {
            this.recalculateInternalValue();
        },
        manualChanged: function(neo, old) {
            this.recalculateInternalValue();
        },
        drugactionsChanged: function(neo, old) {
            this.recalculateInternalValue();
        },
        recalculateInternalValue: function() {
            var v;
            if (Array.isArray(this.drugactions) && this.drugactions.length > 0) {
                var dv = 1;
                for (var i = 0; i < this.drugactions.length; i++) {
                    var da = this.drugactions[i];
                    dv *= da.drugvalue;
                }
                v = dv;
            } else {
                v = this.value;
            }
            this.set('internalValue', v);
        }
    });
</script>

<dom-module id="pathact-drug-option">
    <style>
        :host {
            display: block;
            position: relative;
            box-sizing: border-box;
            word-break: break-all;
            cursor: pointer;
        }

        .name {
            margin-right: 3px;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
    </style>
    <template>
        <label class="jso-control ">
            <input type="checkbox" checked$="{{drug.s}}" on-click="handleClick">
            <span class="name">{{drug.n}}</span>
        </label>
    </template>
</dom-module>
<script>
    Polymer({
        is: 'pathact-drug-option',
        behaviors: [JsoOpencgaManagerBehavior],
        properties: {
            drug: {
                type: Object
            }
        },
        handleClick: function(e) {
            var input = e.currentTarget;
            this.set('drug.s', input.checked);
            this.fire('selected-change', input.checked);
        }
    });
</script>
